# è®¡ç®—æµåŠ¨æ€§

æ²¡æœ‰æµåŠ¨æ€§ï¼Œäº¤æ˜“å°±æ— æ³•è¿›è¡Œã€‚è¦è¿›è¡Œé¦–æ¬¡äº’æ¢ï¼Œæˆ‘ä»¬éœ€è¦å‘èµ„é‡‘æ± åˆçº¦æ³¨å…¥ä¸€äº›æµåŠ¨æ€§ã€‚ä»¥ä¸‹æ˜¯å‘èµ„é‡‘æ± åˆçº¦æ·»åŠ æµåŠ¨æ€§æ‰€éœ€äº†è§£çš„å†…å®¹ï¼š

1. ä»·æ ¼åŒºé—´ã€‚ä½œä¸ºæµåŠ¨æ€§æä¾›å•†ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨ç‰¹å®šçš„ä»·æ ¼åŒºé—´å†…æä¾›æµåŠ¨æ€§ï¼Œå¹¶ä¸”æµåŠ¨æ€§åªä¼šç”¨äºè¯¥åŒºé—´å†…çš„äº¤æ˜“ã€‚
1. æµåŠ¨æ€§é‡‘é¢ï¼Œå³ä¸¤ç§ä»£å¸çš„æ•°é‡ã€‚æˆ‘ä»¬éœ€è¦å°†è¿™äº›ä»£å¸è½¬ç§»åˆ°èµ„é‡‘æ± åˆçº¦ä¸­ã€‚

è¿™é‡Œæˆ‘ä»¬å°†æ‰‹åŠ¨è®¡ç®—è¿™äº›æ•°å€¼ï¼Œä½†åœ¨åé¢çš„ç« èŠ‚ä¸­ï¼Œåˆçº¦å°†è‡ªåŠ¨å®Œæˆè¿™äº›è®¡ç®—ã€‚è®©æˆ‘ä»¬å…ˆä»ä»·æ ¼èŒƒå›´å¼€å§‹ã€‚

## ä»·æ ¼åŒºé—´è®¡ç®—

è¯·è®°ä½ï¼Œåœ¨ Uniswap V3 ä¸­ï¼Œæ•´ä¸ªä»·æ ¼åŒºé—´è¢«åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªâ€œtickâ€ï¼ˆæœ€å°ä»·æ ¼å•ä½ï¼‰ï¼šæ¯ä¸ªâ€œtickâ€å¯¹åº”ä¸€ä¸ªä»·æ ¼ï¼Œå¹¶æœ‰ä¸€ä¸ªç´¢å¼•ã€‚åœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªèµ„é‡‘æ± å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥ 5000 ç¾å…ƒ/1 ETH çš„ä»·æ ¼ç”¨ USDC è´­ä¹° ETHã€‚è´­ä¹° ETH ä¼šä»èµ„é‡‘æ± ä¸­ç§»é™¤ä¸€éƒ¨åˆ†ï¼Œå¹¶å°†ä»·æ ¼æ¨é«˜è‡³ç•¥é«˜äº 5000 ç¾å…ƒã€‚æˆ‘ä»¬å¸Œæœ›æä¾›åŒ…å«æ­¤ä»·æ ¼åŒºé—´çš„æµåŠ¨æ€§ã€‚å¹¶ä¸”æˆ‘ä»¬å¸Œæœ›ç¡®ä¿æœ€ç»ˆä»·æ ¼ä¿æŒåœ¨è¯¥åŒºé—´å†…ï¼ˆæˆ‘ä»¬å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°å¤šåŒºé—´äº’æ¢ï¼‰ã€‚

æˆ‘ä»¬ç¡®å®š3ä¸ª ticks:
1. å½“å‰ä»·æ ¼å˜åŠ¨å•ä½å°†å¯¹åº”äºå½“å‰ä»·æ ¼ï¼ˆ1 ETH å…‘æ¢ 5000 USDCï¼‰ã€‚
1. æˆ‘ä»¬æä¾›æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´çš„ä¸‹é™$l$å’Œä¸Šé™$u$ã€‚å‡è®¾ä¸‹é™ä¸º 4545 ç¾å…ƒï¼Œä¸Šé™ä¸º 5500 ç¾å…ƒã€‚

ä»ç†è®ºä»‹ç»ä¸­æˆ‘ä»¬å¯çŸ¥ï¼š

$$\sqrt{P} = \sqrt{\frac{y}{x}}$$

æ—¢ç„¶æˆ‘ä»¬å·²åŒæ„ä½¿ç”¨  x å‚¨å¤‡é‡‘è¡¨ç¤ºETHï¼Œ y å‚¨å¤‡é‡‘è¡¨ç¤ºUSDCï¼Œå› æ­¤æ¯ä¸ªä»·æ ¼å˜åŠ¨å•ä½çš„ä»·æ ¼å¦‚ä¸‹ï¼š

$$\sqrt{P_c} = \sqrt{\frac{5000}{1}} = \sqrt{5000} \approx 70.71$$

$$\sqrt{P_l} = \sqrt{\frac{4545}{1}} \approx 67.42$$

$$\sqrt{P_u} = \sqrt{\frac{5500}{1}} \approx 74.16$$

å…¶ä¸­ $P_c$â€‹æ˜¯å½“å‰ä»·æ ¼ï¼Œ$P_l$â€‹æ˜¯ä»·æ ¼èŒƒå›´çš„ä¸‹é™ï¼Œ$P_u$ â€‹æ˜¯ä»·æ ¼èŒƒå›´çš„ä¸Šé™ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„tickã€‚æˆ‘ä»¬çŸ¥é“ä»·æ ¼å’Œtickä¹‹é—´çš„å…³ç³»å¯ä»¥é€šè¿‡ä»¥ä¸‹å…¬å¼è¡¨ç¤ºï¼š

$$\sqrt{P(i)}=1.0001^{\frac{i}{2}}$$

æ‰€ä»¥ tick $i$ ç­‰äº:

$$i = log_{\sqrt{1.0001}} \sqrt{P(i)}$$

> è¿™ä¸ªå…¬å¼ä¸­çš„å¹³æ–¹æ ¹ä¼šæ¶ˆæ‰ï¼Œä½†ç”±äºæˆ‘ä»¬éœ€è¦é çš„æ˜¯ $\sqrt{p}$â€‹æˆ‘ä»¬éœ€è¦ä¿ç•™å®ƒä»¬ã€‚ 

æ¥ç®—ç®— ticks:
1. å½“å‰ tick: $i_c = log_{\sqrt{1.0001}} 70.71 = 85176$
1. æœ€ä½ tick: $i_l = log_{\sqrt{1.0001}} 67.42 = 84222$
1. æœ€é«˜ tick: $i_u = log_{\sqrt{1.0001}} 74.16 = 86129$

> ç”¨ python ä»£ç æ¥è®¡ç®—å°±æ˜¯:
> ```python
> import math
>
> def price_to_tick(p):
>     return math.floor(math.log(p, 1.0001))
>
> price_to_tick(5000)
> > 85176
>```

è¿™å°±æ˜¯ä»·æ ¼è®¡ç®—!

æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUniswap ä½¿ç”¨ Q64.96 æ•°æ¥å­˜å‚¨  $\sqrt{P}$ ã€‚è¿™æ˜¯ä¸€ä¸ªå®šç‚¹æ•°ï¼Œæ•´æ•°éƒ¨åˆ†ä¸º 64 ä½ï¼Œå°æ•°éƒ¨åˆ†ä¸º 96 ä½ã€‚åœ¨ä¸Šè¿°è®¡ç®—ä¸­ï¼Œä»·æ ¼å‡ä¸ºæµ®ç‚¹æ•°ï¼š70.71, 67.42, å’Œ 74.16ã€‚æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬è½¬æ¢ä¸º Q64.96ã€‚å¹¸è¿çš„æ˜¯ï¼Œè¿™å¾ˆç®€å•ï¼šæˆ‘ä»¬åªéœ€è¦å°†è¿™äº›æ•°å­—ä¹˜ä»¥ $2^{96}$ ï¼ˆQ æ•°æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å®šç‚¹æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†åè¿›åˆ¶æ•°ä¹˜ä»¥ Q64.96 çš„åŸºæ•°ï¼Œå³ $2^{96}$ ï¼‰ã€‚æˆ‘ä»¬å°†å¾—åˆ°ï¼š

$$\sqrt{P_c} = 5602277097478614198912276234240$$

$$\sqrt{P_l} = 5314786713428871004159001755648$$

$$\sqrt{P_u} = 5875717789736564987741329162240$$

> ç”¨pythonæ¥å†™:
> ```python
> q96 = 2**96
> def price_to_sqrtp(p):
>     return int(math.sqrt(p) * q96)
>
> price_to_sqrtp(5000)
> > 5602277097478614198912276234240
> ```
> æˆ‘ä»¬åœ¨ä¹˜æ³•ä¹‹åå†è¿›è¡Œè½¬æ¢ï¼Œä¸ç„¶å°±ä¼šæŸå¤±ç²¾åº¦ã€‚

## è®¡ç®—ä»£å¸æ•°é‡
ä¸‹ä¸€æ­¥å°±æ˜¯ç¡®å®šæˆ‘ä»¬éœ€è¦åœ¨æ± å­é‡ŒæŠ•å…¥å¤šå°‘ä»£å¸ã€‚ç­”æ¡ˆæ˜¯æƒ³æŠ•å¤šå°‘å°±æŠ•å¤šå°‘ã€‚é‡‘é¢å¹¶æ²¡æœ‰ä¸¥æ ¼çš„å®šä¹‰ï¼Œæˆ‘ä»¬åº”è¯¥å­˜å…¥è¶³å¤Ÿå¤šçš„èµ„é‡‘ï¼Œä»¥ä¾¿è´­ä¹°å°‘é‡ ETHæ—¶ï¼Œå½“å‰ä»·æ ¼ä¸ä¼šåç¦»æˆ‘ä»¬æ³¨å…¥æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´ã€‚åœ¨å¼€å‘å’Œæµ‹è¯•æœŸé—´ï¼Œæˆ‘ä»¬å¯ä»¥é“¸é€ ä»»æ„æ•°é‡çš„ä»£å¸ï¼Œå› æ­¤è·å¾—æˆ‘ä»¬æƒ³è¦çš„æ•°é‡ä¸æˆé—®é¢˜ã€‚

ç¬¬ä¸€æ¬¡å…‘æ¢ï¼Œæˆ‘ä»¬å­˜å…¥ 1 ä¸ª ETH å’Œ 5000 ä¸ª USDCã€‚

> è¯·è®°ä½ï¼Œå½“å‰èµ„é‡‘æ± å‚¨å¤‡çš„æ¯”ä¾‹åæ˜ äº†å½“å‰çš„ç°è´§ä»·æ ¼ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å‘èµ„é‡‘æ± ä¸­æ·»åŠ æ›´å¤šä»£å¸å¹¶ä¿æŒä»·æ ¼ä¸å˜ï¼Œåˆ™æ·»åŠ çš„æ•°é‡å¿…é¡»æˆæ¯”ä¾‹ï¼Œä¾‹å¦‚ï¼š2 ETH å’Œ 10,000 USDCï¼›10 ETH å’Œ 50,000 USDCï¼Œç­‰ç­‰ã€‚


## æµåŠ¨æ€§è®¡ç®—

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å­˜æ¬¾é‡‘é¢è®¡ç®— Lã€‚è¿™éƒ¨åˆ†æ¯”è¾ƒå¤æ‚ï¼Œè¯·ä»”ç»†é˜…è¯»ï¼ ä»ç†è®ºä»‹ç»ä¸­ï¼Œæ‚¨åº”è¯¥è®°å¾—ï¼š


$$L = \sqrt{xy}$$

ç„¶è€Œï¼Œè¿™ä¸ªå…¬å¼æ˜¯é’ˆå¯¹æ— é™åŒºé—´çš„ğŸ™‚ã€‚ä½†æˆ‘ä»¬æƒ³æŠŠæµåŠ¨æ€§æ³¨å…¥åˆ°ä¸€ä¸ªæœ‰é™çš„ä»·æ ¼åŒºé—´ï¼Œä¹Ÿå°±æ˜¯è¿™æ¡æ— é™æ›²çº¿çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬éœ€è¦ä¸“é—¨é’ˆå¯¹æˆ‘ä»¬è¦æ³¨å…¥æµåŠ¨æ€§çš„ä»·æ ¼åŒºé—´æ¥è®¡ç®—æµåŠ¨æ€§ Lã€‚è¿™éœ€è¦ä¸€äº›æ›´å¤æ‚çš„è®¡ç®—ã€‚

ä¸ºäº†è®¡ç®—ä»·æ ¼åŒºé—´çš„ L å€¼ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¹‹å‰è®¨è®ºè¿‡çš„æœ‰è¶£äº‹å®ï¼šä»·æ ¼åŒºé—´å†…çš„ä»£å¸æ•°é‡å¯èƒ½ä¼šè€—å°½ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¯èƒ½ä¹°æ–­ä»·æ ¼åŒºé—´å†…æ‰€æœ‰æŸç§ä»£å¸ï¼Œè€Œæœ€ç»ˆæ± ä¸­åªå‰©ä¸‹å¦ä¸€ç§ä»£å¸ã€‚


![Range depletion example](images/range_depleted.png)

åœ¨ç‚¹ a å’Œç‚¹ bï¼ŒèŒƒå›´å†…åªæœ‰ä¸€ç§ä»£å¸ï¼šç‚¹ a ä¸º ETHï¼Œç‚¹ b ä¸º USDCã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„æµåŠ¨æ€§å€¼ Lï¼Œä½¿ä»·æ ¼èƒ½å¤Ÿæ³¢åŠ¨åˆ°è¿™ä¸¤ä¸ªç‚¹ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚æˆ‘ä»¬éœ€è¦è¶³å¤Ÿçš„æµåŠ¨æ€§ï¼Œä½¿ä»·æ ¼èƒ½å¤Ÿè§¦åŠä»·æ ¼åŒºé—´çš„ä»»ä¸€è¾¹ç•Œã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¸Œæœ› L çš„è®¡ç®—åŸºäº Î”x å’Œ Î”y çš„æœ€å¤§å€¼ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»·æ ¼åœ¨è¾¹ç•Œå¤„çš„å˜åŒ–æƒ…å†µã€‚å½“ä»èµ„é‡‘æ± è´­ä¹° ETH æ—¶ï¼Œä»·æ ¼ä¸Šæ¶¨ï¼›å½“è´­ä¹° USDC æ—¶ï¼Œä»·æ ¼ä¸‹è·Œã€‚è¯·è®°ä½ï¼Œä»·æ ¼æ˜¯ $\frac{y}{x}$ ã€‚å› æ­¤ï¼Œåœ¨ a ç‚¹ï¼Œä»·æ ¼æ˜¯è¯¥åŒºé—´çš„æœ€ä½ç‚¹ï¼›åœ¨ b ç‚¹ï¼Œä»·æ ¼æ˜¯è¯¥åŒºé—´çš„æœ€é«˜ç‚¹ã€‚

> äº‹å®ä¸Šï¼Œè¿™äº›ç‚¹çš„ä»·æ ¼å¹¶æ²¡æœ‰ç¡®å®šï¼Œå› ä¸ºæ± ä¸­åªæœ‰ä¸€ä¸ªå‚¨å¤‡ï¼Œä½†æˆ‘ä»¬éœ€è¦ç†è§£çš„æ˜¯ï¼Œb ç‚¹é™„è¿‘çš„ä»·æ ¼é«˜äºèµ·å§‹ä»·æ ¼ï¼Œè€Œ a ç‚¹çš„ä»·æ ¼ä½äºèµ·å§‹ä»·æ ¼ã€‚

ç°åœ¨ï¼Œå°†ä¸Šå›¾ä¸­çš„æ›²çº¿åˆ†æˆä¸¤æ®µï¼šä¸€æ®µä½äºèµ·ç‚¹å·¦ä¾§ï¼Œä¸€æ®µä½äºèµ·ç‚¹å³ä¾§ã€‚æˆ‘ä»¬å°†è®¡ç®—ä¸¤ä¸ª L ï¼Œæ¯æ®µå¯¹åº”ä¸€ä¸ª L ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºèµ„é‡‘æ± ä¸­çš„ä¸¤ç§ä»£å¸åˆ†åˆ«æ„æˆå…¶ä¸­ä¸€æ®µï¼šå·¦ä¾§æ®µå®Œå…¨ç”±ä»£å¸ x æ„æˆï¼Œå³ä¾§æ®µå®Œå…¨ç”±ä»£å¸ y æ„æˆã€‚è¿™æ˜¯å› ä¸ºåœ¨ä»£å¸äº¤æ¢è¿‡ç¨‹ä¸­ï¼Œä»·æ ¼ä¼šæœä¸¤ä¸ªæ–¹å‘æ³¢åŠ¨ï¼šè¦ä¹ˆä¸Šæ¶¨ï¼Œè¦ä¹ˆä¸‹è·Œã€‚ä»·æ ¼çš„æ³¢åŠ¨åªéœ€è¦ä¸¤ç§ä»£å¸ä¸­çš„ä¸€ç§å³å¯ã€‚
1. å½“ä»·æ ¼ä¸Šæ¶¨æ—¶ï¼Œåªéœ€è¦ä»£å¸ x å³å¯è¿›è¡Œå…‘æ¢ï¼ˆæˆ‘ä»¬è´­ä¹°ä»£å¸ xï¼Œæ‰€ä»¥æˆ‘ä»¬åªæƒ³ä»èµ„é‡‘æ± ä¸­å–å‡ºä»£å¸ xï¼‰ï¼›
1. å½“ä»·æ ¼ä¸‹è·Œæ—¶ï¼Œåªéœ€è¦ä»£å¸ y å³å¯è¿›è¡Œå…‘æ¢ã€‚

å› æ­¤ï¼Œå½“å‰ä»·æ ¼å·¦ä¾§æ›²çº¿æ®µçš„æµåŠ¨æ€§ä»…ç”±ä»£å¸ x æ„æˆï¼Œä¸”ä»…æ ¹æ®æ‰€æä¾›çš„ä»£å¸ x çš„æ•°é‡è®¡ç®—å¾—å‡ºã€‚ç±»ä¼¼åœ°ï¼Œå½“å‰ä»·æ ¼å³ä¾§æ›²çº¿æ®µçš„æµåŠ¨æ€§ä»…ç”±ä»£å¸ y æ„æˆï¼Œä¸”ä»…æ ¹æ®æ‰€æä¾›çš„ä»£å¸ y çš„æ•°é‡è®¡ç®—å¾—å‡ºã€‚

![Liquidity on the curve](images/curve_liquidity.png)

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨æä¾›æµåŠ¨æ€§æ—¶ï¼Œæˆ‘ä»¬ä¼šè®¡ç®—ä¸¤ä¸ªæµåŠ¨æ€§å€¼ï¼ˆLï¼‰ï¼Œç„¶åé€‰æ‹©å…¶ä¸­ä¸€ä¸ªã€‚é€‰æ‹©å“ªä¸ªå‘¢ï¼Ÿè¾ƒå°çš„é‚£ä¸ªã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¾ƒå¤§çš„é‚£ä¸ªå·²ç»åŒ…å«äº†è¾ƒå°çš„é‚£ä¸ªï¼æˆ‘ä»¬å¸Œæœ›æ–°å¢çš„æµåŠ¨æ€§å‡åŒ€åˆ†å¸ƒåœ¨ä»·æ ¼æ›²çº¿ä¸Šï¼Œå› æ­¤éœ€è¦åœ¨å½“å‰ä»·æ ¼çš„å·¦å³ä¸¤ä¾§å„å¢åŠ ç›¸åŒçš„æµåŠ¨æ€§å€¼ã€‚å¦‚æœæˆ‘ä»¬é€‰æ‹©è¾ƒå¤§çš„é‚£ä¸ªï¼Œç”¨æˆ·å°±éœ€è¦æä¾›æ›´å¤šæµåŠ¨æ€§æ¥å¼¥è¡¥è¾ƒå°é‚£ä¸ªçš„èµ„é‡‘ç¼ºå£ã€‚è¿™å½“ç„¶æ˜¯å¯è¡Œçš„ï¼Œä½†è¿™ä¼šä½¿æ™ºèƒ½åˆçº¦æ›´åŠ å¤æ‚ã€‚

> å‰©ä¸‹çš„å¤§ L ä¼šæ€ä¹ˆæ ·ï¼Ÿå…¶å®ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿã€‚é€‰å‡ºå° L ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒè½¬æ¢æˆç»„æˆå¤§ L çš„ä»£å¸çš„è¾ƒå°æ•°é‡â€”â€”è¿™æ ·å°±èƒ½æŠŠå®ƒç¼©å°ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€äº›ä»£å¸ï¼Œå®ƒä»¬éƒ½èƒ½ç»„æˆç›¸åŒçš„ Lã€‚

æœ€åéœ€è¦å¼ºè°ƒçš„æ˜¯ï¼šæ–°å¢æµåŠ¨æ€§ä¸èƒ½æ”¹å˜å½“å‰ä»·æ ¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒå¿…é¡»ä¸å½“å‰å‚¨å¤‡æ¯”ä¾‹æˆæ­£æ¯”ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸¤ä¸ª L å€¼å¯èƒ½ä¸åŒâ€”â€”å½“æ¯”ä¾‹æ— æ³•ç»´æŒæ—¶ã€‚æˆ‘ä»¬ä¼šé€‰æ‹©è¾ƒå°çš„ L å€¼æ¥é‡æ–°å»ºç«‹æ¯”ä¾‹ã€‚

å¸Œæœ›æˆ‘ä»¬ç”¨ä»£ç å®ç°ä¹‹åï¼Œå¤§å®¶èƒ½æ›´å®¹æ˜“ç†è§£ï¼ç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¬å¼ã€‚ æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ Î”x å’Œ Î”y çš„è®¡ç®—æ–¹æ³•ï¼š
$$\Delta x = \Delta \frac{1}{\sqrt{P}} L$$
$$\Delta y = \Delta \sqrt{P} L$$

æˆ‘ä»¬å¯ä»¥é€šè¿‡ç”¨å®é™…ä»·æ ¼ï¼ˆæˆ‘ä»¬ä»ä¸Šé¢çš„å…¬å¼ä¸­å¯ä»¥çŸ¥é“ï¼‰æ›¿æ¢ $\Delta P$ æ¥æ‰©å±•è¿™äº›å…¬å¼ï¼š

$$\Delta x = (\frac{1}{\sqrt{P_c}} - \frac{1}{\sqrt{P_b}}) L$$
$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$

$P_a$ æ˜¯ $a$ ç‚¹çš„ä»·æ ¼, $P_b$ æ˜¯ $b$ ç‚¹çš„ä»·æ ¼,  $P_c$ æ˜¯å½“å‰ä»·æ ¼ (è§ä¸Šå›¾). æ³¨æ„åˆ°ä»·æ ¼ $\frac{y}{x}$ (ä¹Ÿå°±æ˜¯è¯´ $x$ ç›¸å¯¹äº $y$ çš„ä»·æ ¼),  $b$ ç‚¹ä»·æ ¼æ¯”å½“å‰ä»·å’Œ $a$ ç‚¹æ›´é«˜ã€‚ $a$ æ˜¯æœ€ä½ä»·.

æ¥ç”¨ç¬¬ä¸€ä¸ªå…¬ç¤ºæ±‚å‡º $L$ :

$$\Delta x = (\frac{1}{\sqrt{P_c}} - \frac{1}{\sqrt{P_b}}) L$$
$$\Delta x = \frac{L}{\sqrt{P_c}} - \frac{L}{\sqrt{P_b}}$$
$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$
$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$

ç„¶åç”±ç¬¬äºŒä¸ªå…¬ç¤ºå¾—åˆ°:
$$\Delta y = (\sqrt{P_c} - \sqrt{P_a}) L$$
$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$

æ‰€ä»¥æ¯ä¸€æ®µæœ‰ä¸€ä¸ª $L$ è§£:

$$L = \Delta x \frac{\sqrt{P_b} \sqrt{P_c}}{\sqrt{P_b} - \sqrt{P_c}}$$
$$L = \frac{\Delta y}{\sqrt{P_c} - \sqrt{P_a}}$$

æˆ‘ä»¬æŠŠä¹‹å‰è®¡ç®—çš„ä»·æ ¼ä»£å…¥:

$$L = \Delta x \frac{\sqrt{P_b}\sqrt{P_c}}{\sqrt{P_b}-\sqrt{P_c}} = 1 ETH * \frac{5875... * 5602...}{5875... - 5602...}$$

è½¬åŒ–ä¸º Q64.96:

$$L = 1519437308014769733632$$

$L$ çš„å¦ä¸€ä¸ªè§£:
$$L = \frac{\Delta y}{\sqrt{P_c}-\sqrt{P_a}} = \frac{5000USDC}{5602... - 5314...}$$
$$L = 1517882343751509868544$$

æˆ‘ä»¬ä»ä¸­é€‰æ‹©å°çš„é‚£ä¸ªã€‚

>  Python:
> ```python
> sqrtp_low = price_to_sqrtp(4545)
> sqrtp_cur = price_to_sqrtp(5000)
> sqrtp_upp = price_to_sqrtp(5500)
> 
> def liquidity0(amount, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return (amount * (pa * pb) / q96) / (pb - pa)
>
> def liquidity1(amount, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return amount * q96 / (pb - pa)
>
> eth = 10**18
> amount_eth = 1 * eth
> amount_usdc = 5000 * eth
> 
> liq0 = liquidity0(amount_eth, sqrtp_cur, sqrtp_upp)
> liq1 = liquidity1(amount_usdc, sqrtp_cur, sqrtp_low)
> liq = int(min(liq0, liq1))
> > 1517882343751509868544
> ```

## äºŒæ¬¡éªŒè¯ä»£å¸

æ˜¯æˆ‘ä»¬è‡ªå·±å†³å®šçš„å­˜å…¥é‡‘é¢ï¼Œè¿™ä¸ªé‡‘é¢å¯èƒ½ä¸å¯¹ã€‚æˆ‘ä»¬ä¸åº”è¯¥éšæ„åœ¨ä»»ä½•ä»·æ ¼åŒºé—´å­˜å…¥éšæ„é‡‘é¢ï¼ŒæµåŠ¨æ€§éœ€è¦å‡åŒ€åˆ†å¸ƒåœ¨ä»·æ ¼åŒºé—´æ›²çº¿ä¸Šã€‚æ‰€ä»¥ï¼Œå³ä½¿ç”¨æˆ·è‡ªå·±å†³å®šäº†é‡‘é¢ï¼Œåˆçº¦ä¹Ÿè¦äºŒæ¬¡éªŒè¯ã€‚è€Œä¸”å®é™…çš„é‡‘é¢å¯èƒ½ä¼šæœ‰ç‚¹ä¸åŒï¼ˆè‡³å°‘èˆå…¥å€¼ä¼šä¸ä¸€æ ·ï¼‰ã€‚

æˆ‘ä»¬æ—©å°±çŸ¥é“å…¬å¼:

$$\Delta x = \frac{L(\sqrt{P_b} - \sqrt{P_c})}{\sqrt{P_b} \sqrt{P_c}}$$
$$\Delta y = L(\sqrt{P_c} - \sqrt{P_a})$$

>  Python:
> ```python
> def calc_amount0(liq, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return int(liq * q96 * (pb - pa) / pa / pb)
> 
> 
> def calc_amount1(liq, pa, pb):
>     if pa > pb:
>         pa, pb = pb, pa
>     return int(liq * (pb - pa) / q96)
>
> amount0 = calc_amount0(liq, sqrtp_upp, sqrtp_cur)
> amount1 = calc_amount1(liq, sqrtp_low, sqrtp_cur)
> (amount0, amount1)
> > (998976618347425408, 5000000000000000000000)
> ```
> å¦‚ä½ æ‰€è§ï¼Œæ•°å­—å’Œæˆ‘ä»¬è®¡ç®—çš„å¾ˆæ¥è¿‘ï¼Œä½†æ˜¯ETHå‚¨å¤‡ç•¥å°ã€‚

> **æç¤º**: ç”¨ `cast --from-wei AMOUNT` å‘½ä»¤å¯ä»¥ä»weiè½¬æ¢åˆ°ETH, ä¾‹å¦‚.:  
> `cast --from-wei 998976618347425280` å¯ä»¥å¾—åˆ° `0.998976618347425280`.